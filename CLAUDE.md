# CLAUDE.md

## Project

Go URL shortener service using Gin, PostgreSQL (pgxpool), and a 3-layer architecture (handler → service → repository). Includes structured logging via zerolog and a Loki/Promtail/Grafana observability stack.

## Commands

- `make run` — Run the server locally
- `make build` — Build the binary
- `make test` — Run unit tests
- `make lint` — Run golangci-lint
- `make docker-dev-up` — Build and start app + Postgres + Loki + Promtail + Grafana via Docker Compose
- `make docker-prod-up` — Start using pre-built production image (docker-compose.prod.yml overlay)
- `make docker-down` — Stop containers
- `DATABASE_URL="postgres://urlshortener:urlshortener@localhost:5432/urlshortener?sslmode=disable" make test` — Run tests including integration tests

## Code Conventions

- 3-layer architecture: handler → service → repository. Keep layers separate.
- `internal/middleware/` holds Gin middleware (currently: structured request logger using zerolog).
- Repository layer uses an interface (`URLRepository`) for testability.
- Use `gomock` for mocking interfaces in tests; generated mocks live in `internal/repository/mocks/`.
- Handler tests use `httptest` with a real Gin router.
- Repository tests are integration tests that require `DATABASE_URL` env var and skip gracefully without it.
- Config is loaded from environment variables (`APP_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT`), no config files.
- Migrations are plain SQL files in `migrations/` and run automatically on startup.
- Short codes are 7-character random base62 strings.
- Database IDs are UUIDs (generated by PostgreSQL's `gen_random_uuid()`), not sequential integers.
- Logging uses zerolog; the middleware logger emits structured JSON with IP, method, path, status, latency, and user-agent.
- Observability config (Loki, Promtail, Grafana datasources) lives in `config/`.
- Always run `make test` and `make lint` before finishing work to ensure tests pass and there are no linter issues.
